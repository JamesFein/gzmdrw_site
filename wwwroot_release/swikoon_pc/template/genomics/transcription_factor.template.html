<!DOCTYPE html>
<html lang="en">

<head>
  <!-- 基本的元信息设置 -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- 页面标题: 产品标题_站点名称 -->
  <title>${Catalog.name}_${Site.name}</title>

  <!-- CSS 引入 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet'>

  <!-- 添加 DataTables CSS -->
  <link href="https://cdn.datatables.net/2.0.0/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/buttons/3.0.0/css/buttons.bootstrap5.min.css" rel="stylesheet">
  
  <!-- 自定义样式 -->
  <style>
    body {
      font-family: 'Lato', sans-serif;
      line-height: 1.6;
      background-color: #f1f5ec;
    }
    a {
      text-decoration: none;
      color: black;
    }
    .text-decoration-underline-hover:hover {
      text-decoration: underline;
    }
    .nav-link {
      color: #475c57;
    }
    .nav-link:hover {
      color: #0C4034 !important;
    }
    
    /* 添加表格相关样式 */
    .table-responsive {
      width: 100%;
      margin: 0;
      padding: 0;
    }
    
    #geneTable {
      width: 100% !important;
    }
    
    .dataTables_wrapper {
      width: 100%;
    }
  </style>
</head>

<body>
  <!-- 引入头部模板 -->
  <@cms_include file="common/home_header.template.html"></@cms_include>

  <!-- 主要内容区域 -->
  <div class="container py-4">
    <div class="row card rounded-4 shadow-sm border" style="border-color: rgba(0, 0, 0, 0.125) !important;">
        <div class="row p-4">
          <!-- 左侧导航菜单 -->
          <div class="col-lg-2 col-sm-3 mb-3">
            <@cms_include file="common/nav_left.template.html"></@cms_include>
          </div>
         
          <div class="col-lg-10 col-sm-9">
            <h2>
              <span id="browse_by_family_titile">Browse by Family (Total TF Number 5954)</span>
              <span id="browse_by_gene_id_title">Browse by Gene Id</span>
            </h2>
            <p class="mb-4">
              The following is a collection of transcription factors in the family. Click to view all the rape genes contained in the family. 
              Or you can enter interested genes and then get relevant genetic family information.
            </p>

            <!-- Browse by Family start -->
            <div id="browse_by_family" class="mb-4 p-4">
              <h3
                class="text-left d-flex justify-content-between align-items-center mb-4"
                style="font-size: 1.2rem"
              >
                <span class="text-dark fw-semibold">Browse by Family (Total TF Number 5954)</span>
              </h3>
              
              <div class="classification d-flex flex-wrap gap-2">
                <span class="text-success text-decoration-underline-hover">AP2 (57)</span>
                <span class="text-success text-decoration-underline-hover">ARF (64)</span>
                <span class="text-success text-decoration-underline-hover">ARR-B (45)</span>
                <span class="text-success text-decoration-underline-hover">B3 (222)</span>
                <span class="text-success text-decoration-underline-hover">BBR-BPC (24)</span>
                <span class="text-success text-decoration-underline-hover">BES1 (23)</span>
                <span class="text-success text-decoration-underline-hover">C2H2 (373)</span>
                <span class="text-success text-decoration-underline-hover">C3H (155)</span>
                <span class="text-success text-decoration-underline-hover">CAMTA (22)</span>
                <span class="text-success text-decoration-underline-hover">CO-like (48)</span>
                <span class="text-success text-decoration-underline-hover">CPP (34)</span>
                <span class="text-success text-decoration-underline-hover">DBB (33)</span>
                <span class="text-success text-decoration-underline-hover">Dof (149)</span>
                <span class="text-success text-decoration-underline-hover">E2F/DP (31)</span>
                <span class="text-success text-decoration-underline-hover">EIL (25)</span>
                <span class="text-success text-decoration-underline-hover">ERF (464)</span>
                <span class="text-success text-decoration-underline-hover">FAR1 (29)</span>
                <span class="text-success text-decoration-underline-hover">G2-like (174)</span>
                <span class="text-success text-decoration-underline-hover">GATA (114)</span>
                <span class="text-success text-decoration-underline-hover">GRAS (105)</span>
                <span class="text-success text-decoration-underline-hover">GRF (33)</span>
                <span class="text-success text-decoration-underline-hover">GeBP (39)</span>
                <span class="text-success text-decoration-underline-hover">HB-PHD (8)</span>
                <span class="text-success text-decoration-underline-hover">HB-other (20)</span>
                <span class="text-success text-decoration-underline-hover">HD-ZIP (191)</span>
                <span class="text-success text-decoration-underline-hover">HRT-like (7)</span>
                <span class="text-success text-decoration-underline-hover">HSF (63)</span>
                <span class="text-success text-decoration-underline-hover">LBD (146)</span>
                <span class="text-success text-decoration-underline-hover">LFY (4)</span>
                <span class="text-success text-decoration-underline-hover">LSD (12)</span>
                <span class="text-success text-decoration-underline-hover">M-type_MADS (142)</span>
                <span class="text-success text-decoration-underline-hover">MIKC_MADS (149)</span>
                <span class="text-success text-decoration-underline-hover">MYB (462)</span>
                <span class="text-success text-decoration-underline-hover">MYB_related (263)</span>
                <span class="text-success text-decoration-underline-hover">NAC (393)</span>
                <span class="text-success text-decoration-underline-hover">NF-X1 (8)</span>
                <span class="text-success text-decoration-underline-hover">NF-YA (36)</span>
                <span class="text-success text-decoration-underline-hover">NF-YB (50)</span>
                <span class="text-success text-decoration-underline-hover">NF-YC (25)</span>
                <span class="text-success text-decoration-underline-hover">NZZ/SPL (4)</span>
                <span class="text-success text-decoration-underline-hover">Nin-like (47)</span>
                <span class="text-success text-decoration-underline-hover">RAV (26)</span>
                <span class="text-success text-decoration-underline-hover">S1Fa-like (7)</span>
                <span class="text-success text-decoration-underline-hover">SAP (2)</span>
                <span class="text-success text-decoration-underline-hover">SBP (62)</span>
                <span class="text-success text-decoration-underline-hover">SRS (40)</span>
                <span class="text-success text-decoration-underline-hover">STAT (2)</span>
                <span class="text-success text-decoration-underline-hover">TALE (59)</span>
                <span class="text-success text-decoration-underline-hover">TCP (81)</span>
                <span class="text-success text-decoration-underline-hover">Trihelix (109)</span>
                <span class="text-success text-decoration-underline-hover">VOZ (8)</span>
                <span class="text-success text-decoration-underline-hover">WOX (57)</span>
                <span class="text-success text-decoration-underline-hover">WRKY (278)</span>
                <span class="text-success text-decoration-underline-hover">Whirly (6)</span>
                <span class="text-success text-decoration-underline-hover">YABBY (22)</span>
                <span class="text-success text-decoration-underline-hover">ZF-HD (65)</span>
                <span class="text-success text-decoration-underline-hover">bHLH (566)</span>
                <span class="text-success text-decoration-underline-hover">bZIP (271)</span>
              </div>
            </div>
            <!-- Browse by Family end -->

            <!-- Browse by Gene ID start -->
            <div id="browse_by_gene_id" class="mb-4 p-4">
              <h3
                class="text-left d-flex justify-content-between align-items-center mb-4"
                style="font-size: 1.2rem"
              >
                <span class="text-dark fw-semibold">Browse by Gene Id</span>
              </h3>
              <div class="form-content">
                <form id="geneIndexForm">
                  <!-- Gene ID Input -->
                  <div class="mb-4">
                    <div class="d-flex align-items-center">
                      <label for="geneId" class="mb-0 fw-500 me-2" style="min-width: 80px"
                        >Search By Gene Id</label
                      >
                      <div class="flex-grow-1 d-flex align-items-center">
                        <input type="text" class="form-control" id="geneId" value="" />
                        <button type="button" class="btn btn-success ms-2" id="searchByGeneIDBtn">
                          <i class="fas fa-search"></i>
                        </button>
                        <span
                          class="ms-2"
                          data-bs-toggle="tooltip"
                          data-bs-placement="top"
                          title="Help information about Gene ID"
                          style="cursor: pointer"
                          >?</span
                        >
                      </div>
                    </div>
                    <div class="mt-2 fst-italic example_gene_id" style="cursor: pointer; color: #8aaa39">
                      e.g.
                      <span class="text-decoration-underline">BnaA01G0012600ZS</span>,
                      <span class="text-decoration-underline">FLC</span>,
                      <span class="text-decoration-underline">AT5G10140</span>,
                      <span class="text-decoration-underline">BnaA01G0012100GG</span>
                    </div>
                  </div>
                </form>
              </div>
            </div>
            <!-- Browse by Gene ID end -->

            <!-- search results start -->
            <div id="search_result" class="bg-white rounded shadow-sm mb-4 p-4" style="color: #0c4034">
              <h2
                class="section-header text-left mb-4"
                style="cursor: pointer; font-size: 1.2rem"
              >
                <span class="text-dark fw-semibold">Results of &nbsp;
                </span><span id="family_name" style="color: red;"></span> &nbsp;&nbsp;
                <span id="gene_id" style="color: red;"> </span> &nbsp;&nbsp;
              </h2>
              <div class="table-responsive">
                <table id="geneTable" class="table table-striped table-bordered">
                  <thead>
                    <tr>
                      <th class="align-top">ZS11 Gene ID</th>
                      <th class="align-top">TF Type</th>
                      <th class="align-top">AtGI</th>
                      <th class="align-top">At Name</th>
                      <th class="align-top">Genomic Position</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td colspan="12" class="text-center">Loading data...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <!-- search results end -->

            <!-- 正文内容 end -->
          </div>
        </div>
    </div>
  </div>

  <!-- 引入页脚模板 -->
  <@cms_include file="common/home_footer.template.html"></@cms_include>

  <!-- JS 引入 -->
  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.0/js/dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.0/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.0.0/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.0.0/js/buttons.html5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

  <!-- 确保在初始化表格之前加载数据和过滤器 -->
  <script src="${Prefix}js/mock_data/tf_data.js"></script>
  <script src="${Prefix}js/filterGeneData.js"></script>
  
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      /*********************************************
       * 页面初始化
       *********************************************/
      
      // 1. 数据检查：确保基因数据已经正确加载
      if (typeof geneData === 'undefined') {
        console.error('Gene data not loaded'); // 在控制台输出错误信息
        // 创建错误提示元素
        const errorMessage = document.createElement("div");
        errorMessage.className = "alert alert-danger";
        errorMessage.textContent = "Failed to load gene data. Please refresh the page.";
        // 将错误信息插入到表格前面
        document.querySelector("#geneTable").before(errorMessage);
        return;
      }

      // 2. 初始化数据过滤器和表格（默认显示AP2家族数据）
      const dataFilter = new GeneDataFilter(geneData);
      initializeGeneTable(dataFilter.getInitialData());
      
      // 3. 设置各个区域的事件处理器
      setupFamilyClickHandlers(dataFilter);      // "Browse by Family" 区域的点击事件
      setupExampleGeneClickHandlers(dataFilter); // "Browse by Gene Id" 区域的示例基因点击事件
      setupGeneSearchHandler(dataFilter);        // "Browse by Gene Id" 区域的搜索功能
      
      // 4. 设置默认显示的家族名称为AP2（显示在 search_result 区域）
      document.getElementById('family_name').textContent = 'AP2 Family';
    });

    /*********************************************
     * "Browse by Family" 区域处理函数
     * 对应页面中 <div id="browse_by_family"> 部分
     *********************************************/
    const setupFamilyClickHandlers = (dataFilter) => {
      // 获取所有家族span元素
      const spans = document.querySelectorAll('.classification span');
      
      // 为每个span添加点击事件监听器
      spans.forEach(span => {
        span.addEventListener('click', (e) => {
          // 获取点击元素的完整文本（例如："AP2 (57)"）
          const fullText = e.target.textContent.trim();
          // 提取家族名称，去掉括号中的数字（例如：获取"AP2"）
          const familyName = fullText.split(' (')[0];
          
          // 更新页面显示
          document.getElementById('family_name').textContent = familyName + ' Family';
          document.getElementById('gene_id').textContent = ''; // 清空基因ID显示
          
          // 过滤数据并更新表格
          const filteredData = dataFilter.filterByFamily(familyName);
          updateTableData(filteredData);
        });
      });
    };

    /*********************************************
     * 搜索结果表格初始化
     * 对应页面中 <div id="search_result"> 部分
     *********************************************/
    const initializeGeneTable = (initialData) => {
      try {
        // 1. 检查必要的库是否加载
        if (!window.jQuery || !$.fn.DataTable) {
          console.error('jQuery or DataTables not loaded');
          throw new Error("Required libraries not loaded");
        }

        // 2. 如果表格已经初始化，先销毁它
        if ($.fn.DataTable.isDataTable("#geneTable")) {
          $("#geneTable").DataTable().destroy();
        }

        // 3. 初始化DataTable表格
        const table = $("#geneTable").DataTable({
          data: initialData,  // 设置表格数据
          columns: [          // 定义表格列
            { data: 'geneId' },   // 基因ID列
            { data: 'tfType' },   // 转录因子类型列
            { data: 'atgi' },     // ATGI列
            { data: 'atName' },   // AT名称列
            { data: 'position' }  // 基因组位置列
          ],
          order: [[0, "asc"]],        // 默认按第一列升序排序
          autoWidth: true,            // 自动调整列宽
          scrollX: true,              // 允许水平滚动
          scrollCollapse: true,       // 允许表格折叠
          paging: true,               // 启用分页
          searching: false,           // 禁用内置搜索
          info: true,                 // 显示信息
          // 定义表格布局
          dom: '<"row p-2"<"col-sm-12 col-md-6"B><"col-sm-12 col-md-6"f>>' +
               '<"row"<"col-sm-12"tr>>' +
               '<"row p-2"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7 d-flex justify-content-end"p>>',
          // 添加导出按钮
          buttons: [
            {
              extend: "excel",        // 导出为Excel
              text: '<i class="fas fa-file-excel"></i> Export Excel',
              className: "btn btn-success",
              title: "Basic Information of Genes",
              exportOptions: {
                columns: ':visible'   // 只导出可见列
              }
            },
          ],
          // 自定义语言
          language: {
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            infoEmpty: "Showing 0 to 0 of 0 entries",
            infoFiltered: "",
          },
        });

        // 4. 调整列宽并重绘表格
        table.columns.adjust().draw();
        
      } catch (error) {
        // 错误处理：显示错误信息
        console.error("Table initialization failed:", error);
        const errorMessage = document.createElement("div");
        errorMessage.className = "alert alert-danger";
        errorMessage.textContent = "Failed to initialize table. Please refresh the page.";
        document.querySelector("#geneTable").before(errorMessage);
      }
    };

    /*********************************************
     * 表格数据更新函数
     * 用于更新 search_result 区域的表格数据
     *********************************************/
    const updateTableData = (newData) => {
      const table = $('#geneTable').DataTable();
      table.clear();              // 清空现有数据
      table.rows.add(newData);    // 添加新数据
      table.draw();              // 重绘表格
    };

    /*********************************************
     * "Browse by Gene Id" 区域搜索功能
     * 对应页面中 <div id="browse_by_gene_id"> 部分的搜索框和按钮
     *********************************************/
    const setupGeneSearchHandler = (dataFilter) => {
      // 定义搜索处理函数
      const searchHandler = () => {
        // 获取搜索输入框的值并去除空格
        const geneId = document.getElementById('geneId').value.trim();
        
        // 更新显示文本
        document.getElementById('family_name').textContent = '';
        document.getElementById('gene_id').textContent = 'Gene ID: ' + geneId;
        
        // 过滤数据并更新表格
        const filteredData = dataFilter.filterByGeneId(geneId);
        updateTableData(filteredData);
      };

      // 为搜索按钮添加点击事件
      document.getElementById('searchByGeneIDBtn').addEventListener('click', searchHandler);

      // 为输入框添加回车键事件
      document.getElementById('geneId').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault(); // 阻止表单提交
          searchHandler();
        }
      });
    };

    /*********************************************
     * "Browse by Gene Id" 区域示例基因点击功能
     * 对应页面中 class="example_gene_id" 部分的示例基因
     *********************************************/
    const setupExampleGeneClickHandlers = (dataFilter) => {
      // 获取所有示例基因span元素
      const exampleGenes = document.querySelectorAll('.example_gene_id span');
      
      // 为每个示例基因添加点击事件
      exampleGenes.forEach(span => {
        span.addEventListener('click', (e) => {
          const geneText = e.target.textContent.trim();
          
          // 设置搜索输入框的值
          document.getElementById('geneId').value = geneText;
          
          // 更新显示文本
          document.getElementById('family_name').textContent = '';
          document.getElementById('gene_id').textContent = 'Gene ID: ' + geneText;
          
          // 过滤数据并更新表格
          const filteredData = dataFilter.filterByGeneId(geneText);
          updateTableData(filteredData);
        });
      });
    };
  </script>

</body>

</html>